name: Validate issue

on:
  issues:
    types:
      - opened

jobs:
  validate-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Check for reproduction
        uses: actions/github-script@v6
        with:
          script: |
            const excludeLinks = [
              'https://github.com/uni-stack/'
            ];

            const reproductionKeywords = [
              'github.com'
            ];

            // Helper function to get the base URL without query parameters or fragments
            function getBaseUrl(url) {
              try {
                const parsedUrl = new URL(url);
                return `${parsedUrl.origin}${parsedUrl.pathname}`;
              } catch {
                return url;
              }
            }

            const issueBody = context.payload.issue.body || '';
            const issueBodyLower = issueBody.toLowerCase();

            // Extract base URLs for comparison
            const issueLinks = issueBodyLower.match(/https?:\/\/[^\s)]+/g) || [];
            const issueBaseLinks = issueLinks.map(getBaseUrl);

            // Extract base URLs from excluded links
            const excludedBaseLinks = excludeLinks.map(link => getBaseUrl(link).toLowerCase());
            
            // Check if the issue contains any of the excluded links only
            const hasOnlyExcludedLinks = issueBaseLinks.every(link =>
              excludedBaseLinks.includes(link)
            );

            // Check if there's a valid reproduction link
            const hasReproduction = reproductionKeywords.some(keyword =>
              issueBaseLinks.some(link => link.includes(keyword))
            );

            if (!hasReproduction || hasOnlyExcludedLinks) {
              const issueNumber = context.payload.issue.number;
              const commentBody = `This issue has been automatically closed because it **lacks a clear, minimal reproduction** that we can use to verify the reported bug.`;

              // Post the comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: commentBody
              });

              // Add label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['repro-required']
              });

              // Close the issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'closed'
              });
            }
